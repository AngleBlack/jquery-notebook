!function(e,t,n){var i,o=function(){var e=function(e){return e&&"none"!=e?e.match(/(-?[0-9\.]+)/g):[1,0,0,1,0,0]},t=function(e){return e.css("-webkit-transform")||e.css("transform")||e.css("-moz-transform")||e.css("-o-transform")||e.css("-ms-transform")},n=function(n){var i=t(n);return e(i)},i=function(e,t){e.css("-webkit-transform",t),e.css("-moz-transform",t),e.css("-o-transform",t),e.css("-ms-transform",t),e.css("transform",t)},o=function(e){return"matrix("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},a=function(e){var t=n(e);return{x:parseInt(t[4]),y:parseInt(t[5])}},s=function(e,t){var a=n(e);a[0]=a[3]=t;var s=o(a);i(e,s)},c=function(e,t,a){var s=n(e);s[4]=t,s[5]=a;var c=o(s);i(e,c)},r=function(e,t){var a=n(e),s=t*(Math.PI/180),c=-1*s;a[1]=s,a[2]=c;var r=o(a);i(e,r)};return{scale:s,translate:c,rotate:r,getTranslate:a}}(),a="MacIntel"==n.navigator.platform,s=0,c=0,r={command:!1,shift:!1},l={66:"bold",73:"italic",85:"underline",112:"h1",113:"h2",122:"undo"},u={keyboard:{isCommand:function(e,t,n){a&&e.metaKey||!a&&e.ctrlKey?t():n()},isShift:function(e,t,n){e.shiftKey?t():n()},isModifier:function(e,t){var n=e.which,i=l[n];i&&t.call(this,i)},isEnter:function(e,t){13===e.which&&t()},isArrow:function(e,t){(e.which>=37||e.which<=40)&&t()}},html:{addTag:function(n,i,o,a){var s=e(t.createElement(i));return s.attr("contenteditable",Boolean(a)),s.append(" "),n.append(s),o&&(r.focusedElement=n.children().last(),u.cursor.set(n,0,r.focusedElement)),s}},cursor:{set:function(e,i,o){var a;if(t.createRange){a=t.createRange();var s=n.getSelection(),c=e.children().last(),r=c.html().length-1,l=o?o[0]:c[0],u="undefined"!=typeof i?i:r;a.setStart(l,u),a.collapse(!0),s.removeAllRanges(),s.addRange(a)}else a=t.body.createTextRange(),a.moveToElementText(o),a.collapse(!1),a.select()}},selection:{save:function(){if(n.getSelection){var e=n.getSelection();if(e.rangeCount>0)return e.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restore:function(e){if(e)if(n.getSelection){var i=n.getSelection();i.removeAllRanges(),i.addRange(e)}else t.selection&&e.select&&e.select()},getText:function(){var e="";return n.getSelection?e=n.getSelection().toString():t.getSelection?e=t.getSelection().toString():t.selection&&(e=t.selection.createRange().text),e},clear:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}},validation:{isUrl:function(e){return/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(e)}}},d={updatePos:function(e,t){var i=n.getSelection(),a=i.getRangeAt(0),s=a.getBoundingClientRect(),c=t.width(),r=t.height(),l=(e.offset().left,{x:s.left+s.width/2-c/2,y:s.top-r-8});o.translate(t,l.x,l.y)},updateState:function(e,t){t.find("button").removeClass("active");var i=n.getSelection(),o=[];d.checkForFormatting(i.focusNode,o);for(var a={b:"bold",i:"italic",h1:"h1",h2:"h2",a:"anchor"},s=0;s<o.length;s++){var c=o[s];t.find("button."+a[c]).addClass("active")}},checkForFormatting:function(e,t){var n=["b","i","u","h1","h2","a"];("#text"===e.nodeName||-1!=n.indexOf(e.nodeName.toLowerCase()))&&("#text"!=e.nodeName&&t.push(e.nodeName.toLowerCase()),d.checkForFormatting(e.parentNode,t))},buildMenu:function(t,n){var o=u.html.addTag(n,"ul",!1,!1);for(var a in i.modifiers){var s=u.html.addTag(o,"li",!1,!1),c=u.html.addTag(s,"button",!1,!1);c.attr("editor-command",i.modifiers[a]),c.addClass(i.modifiers[a])}n.find("button").click(function(n){n.preventDefault();var i=e(this).attr("editor-command");m.commands[i].call(t,n)});var r=u.html.addTag(n,"div",!1,!1);r.addClass("link-area");var l=u.html.addTag(r,"input",!1,!1);l.attr({type:"text"});var d=u.html.addTag(r,"button",!1,!1);d.click(function(t){t.preventDefault();e(this).closest(".editor");e(this).closest(".link-area").hide(),e(this).closest(".bubble").find("ul").show()})},show:function(){var t=e(this).parent().find(".bubble");t.length||(t=u.html.addTag(e(this).parent(),"div",!1,!1),t.addClass("jquery-notebook bubble"),d.buildMenu(this,t)),t.show(),d.updateState(this,t),t.addClass("active"),d.updatePos(e(this),t)},update:function(){var t=e(this).parent().find(".bubble");d.updateState(this,t)},clear:function(){var t=e(this).parent().find(".bubble");t.hasClass("active")&&(console.log("clear"),t.removeClass("active"),d.hideLinkInput.call(this),d.showButtons.call(this),setTimeout(function(){t.hasClass("active")||t.hide()},500))},hideButtons:function(){e(this).parent().find(".bubble").find("ul").hide()},showButtons:function(){e(this).parent().find(".bubble").find("ul").show()},showLinkInput:function(t){d.hideButtons.call(this);var n=this,i=e(this).parent().find(".bubble").find("input[type=text]");i.unbind("keydown"),i.keydown(function(i){var o=e(this);u.keyboard.isEnter(i,function(){i.preventDefault();var e=o.val();u.validation.isUrl(e)&&(i.url=e,m.commands.createLink(i,t),d.clear.call(n))})}),i.bind("paste",function(){var t=e(this);setTimeout(function(){var e=t.val();/http:\/\/https?:\/\//.test(e)&&(e=e.substring(7),t.val(e))},1)}),e(this).parent().find(".link-area").show(),i.val("http://").focus()},hideLinkInput:function(){e(this).parent().find(".bubble").find(".link-area").hide()}},f={bindEvents:function(e){e.keydown(h.keydown),e.keyup(h.keyup),e.focus(h.focus),e.bind("paste",m.paste),e.mousedown(h.mouseClick),e.mouseup(h.mouseUp),e.mousemove(h.mouseMove),e.blur(h.blur)},setPlaceholder:function(t){if(/^\s*$/.test(e(this).text())){e(this).empty();var n=u.html.addTag(e(this),"p").addClass("placeholder");n.append(e(this).attr("editor-placeholder")),u.html.addTag(e(this),"p","undefined"!=typeof t.focus?t.focus:!1,!0)}else e(this).find(".placeholder").remove()},preserveElementFocus:function(){var e=n.getSelection()?n.getSelection().anchorNode:t.activeElement;if(e){var i=e.parentNode,o=i!==r.focusedElement,a=this.children,s=0;i===this&&(i=e);for(var c=0;c<a.length;c++)if(i===a[c]){s=c;break}o&&(r.focusedElement=i,r.focusedElementIndex=s)}},prepare:function(e,t){if(i=t,e.attr("editor-mode",i.mode),e.attr("editor-placeholder",i.placeholder),e.attr("contenteditable",!0),e.css("position","relative"),e.addClass("jquery-notebook editor"),f.setPlaceholder.call(e,{}),f.preserveElementFocus.call(e),i.autoFocus===!0){var n=e.find("p:not(.placeholder)");u.cursor.set(e,0,n)}}},h={keydown:function(e){var t=this;u.keyboard.isCommand(e,function(){r.command=!0},function(){r.command=!1}),u.keyboard.isShift(e,function(){r.shift=!0},function(){r.shift=!1}),u.keyboard.isModifier.call(this,e,function(t){r.command&&m.commands[t].call(this,e)}),r.shift?u.keyboard.isArrow.call(this,e,function(){setTimeout(function(){var e=u.selection.getText();""!==e?d.show.call(t):d.clear.call(t)},100)}):u.keyboard.isArrow.call(this,e,function(){d.clear.call(t)}),13===e.which&&m.enterKey.call(this,e),27===e.which&&d.clear.call(this),86===e.which&&m.paste.call(this,e)},keyup:function(e){u.keyboard.isCommand(e,function(){r.command=!1},function(){r.command=!0}),f.preserveElementFocus.call(this),f.setPlaceholder.call(this,{focus:!0})},focus:function(){r.command=!1,r.shift=!1},mouseClick:function(t){var n=this;if(2===t.button)return setTimeout(function(){d.show.call(n)},50),void t.preventDefault();if(e(this).find(".bubble:visible").length){var i=e(this).find(".bubble:visible"),o=i.offset().left,a=i.offset().top,r=i.width(),l=i.height();if(s>o&&o+r>s&&c>a&&a+l>c)return}},mouseUp:function(){var e=this;setTimeout(function(){var t=u.selection.save();t.collapsed?d.clear.call(e):d.show.call(e)},50)},mouseMove:function(e){s=e.pageX,c=e.pageY},blur:function(){}},m={commands:{bold:function(e){e.preventDefault(),t.execCommand("bold",!1),d.update.call(this)},italic:function(e){e.preventDefault(),t.execCommand("italic",!1),d.update.call(this)},underline:function(e){e.preventDefault(),t.execCommand("underline",!1),d.update.call(this)},anchor:function(e){e.preventDefault();var t=u.selection.save();d.showLinkInput.call(this,t)},createLink:function(e,n){u.selection.restore(n),t.execCommand("createLink",!1,e.url),d.update.call(this)},h1:function(e){e.preventDefault(),t.execCommand("formatBlock",!1,"<h1>"),d.update.call(this)},h2:function(e){e.preventDefault(),t.execCommand("formatBlock",!1,"<h2>"),d.update.call(this)},undo:function(e){e.preventDefault(),t.execCommand("undo",!1)}},enterKey:function(t){return"inline"===e(this).attr("editor-mode")?void t.preventDefault():void 0},paste:function(){var t=e(this);setTimeout(function(){t.find("*").each(function(){var t=e(this);e.each(this.attributes,function(){"class"===this.name&&t.hasClass("placeholder")||t.removeAttr(this.name)})})},100)}};e.fn.notebook=function(t){return t=e.extend({},e.fn.notebook.defaults,t),f.prepare(this,t),f.bindEvents(this),this},e.fn.notebook.defaults={autoFocus:!1,placeholder:"Your text here...",mode:"inline",modifiers:["bold","italic","underline","h1","h2","anchor"]}}(jQuery,document,window);