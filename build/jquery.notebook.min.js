!function(e,t,n){var o=function(){var e=function(e){return e&&"none"!=e?e.match(/(-?[0-9\.]+)/g):[1,0,0,1,0,0]},t=function(e){return e.css("-webkit-transform")||e.css("transform")||e.css("-moz-transform")||e.css("-o-transform")||e.css("-ms-transform")},n=function(n){var o=t(n);return e(o)},o=function(e,t){e.css("-webkit-transform",t),e.css("-moz-transform",t),e.css("-o-transform",t),e.css("-ms-transform",t),e.css("transform",t)},i=function(e){return"matrix("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},a=function(e){var t=n(e);return{x:parseInt(t[4]),y:parseInt(t[5])}},l=function(e,t){var a=n(e);a[0]=a[3]=t;var l=i(a);o(e,l)},r=function(e,t,a){var l=n(e);l[4]=t,l[5]=a;var r=i(l);o(e,r)},s=function(e,t){var a=n(e),l=t*(Math.PI/180),r=-1*l;a[1]=l,a[2]=r;var s=i(a);o(e,s)};return{scale:l,translate:r,rotate:s,getTranslate:a}}(),i=function(o,i){var r=this,s=0,c=0,u={command:!1,shift:!1,isSelecting:!1};e.extend(r,{init:function(){r.element=e(o),r.options=i,r.utils=new a,r.bubble=new l(r),r.prepare(),r.bindEvents()},bindEvents:function(){r.element.keydown(r.rawEvents.keydown),r.element.keyup(r.rawEvents.keyup),r.element.focus(r.rawEvents.focus),r.element.bind("paste",r.events.paste),r.element.mousedown(r.rawEvents.mouseClick),r.element.mouseup(r.rawEvents.mouseUp),r.element.mousemove(r.rawEvents.mouseMove),r.element.blur(r.rawEvents.blur),e("body").mouseup(function(e){e.target==e.currentTarget&&u.isSelecting&&r.rawEvents.mouseUp(e)})},setPlaceholder:function(e){if(/^\s*$/.test(r.element.text())){r.element.empty();var t=r.utils.html.addTag(r.element,"p").addClass("placeholder");t.append(r.element.attr("editor-placeholder")),r.utils.html.addTag(r.element,"p","undefined"!=typeof e.focus?e.focus:!1,!0)}else r.element.find(".placeholder").remove()},removePlaceholder:function(){r.element.find(".placeholder").remove()},preserveElementFocus:function(){var e=n.getSelection()?n.getSelection().anchorNode:t.activeElement;if(e){var o=e.parentNode,i=o!==u.focusedElement,a=r.element[0].children,l=0;o===r.element[0]&&(o=e);for(var s=0;s<a.length;s++)if(o===a[s]){l=s;break}i&&(u.focusedElement=o,u.focusedElementIndex=l)}},prepare:function(){if(r.element.attr("editor-mode",r.options.mode),r.element.attr("editor-placeholder",r.options.placeholder),r.element.attr("contenteditable",!0),r.element.css("position","relative"),r.element.addClass("jquery-notebook editor"),r.setPlaceholder({}),r.preserveElementFocus(),i.autoFocus===!0){var e=r.element.find("p:not(.placeholder)");r.utils.cursor.set(r.element,0,e)}},rawEvents:{keydown:function(e){u.command&&65===e.which&&setTimeout(function(){r.bubble.show()},50),r.utils.keyboard.isCommand(e,function(){u.command=!0},function(){u.command=!1}),r.utils.keyboard.isShift(e,function(){u.shift=!0},function(){u.shift=!1}),r.utils.keyboard.isModifier(e,function(t){u.command&&r.events.commands[t](e)}),u.shift?r.utils.keyboard.isArrow(e,function(){setTimeout(function(){var e=r.utils.selection.getText();""!==e?r.bubble.show():r.bubble.clear()},100)}):r.utils.keyboard.isArrow(e,function(){r.bubble.clear()}),13===e.which&&r.events.enterKey(),27===e.which&&r.bubble.clear(),86===e.which&&this.events.paste(e)},keyup:function(t){r.utils.keyboard.isCommand(t,function(){u.command=!1},function(){u.command=!0}),r.preserveElementFocus(),r.removePlaceholder(),/^\s*$/.test(e(this).text())&&(e(this).empty(),r.utils.html.addTag(e(this),"p",!0,!0))},focus:function(){u.command=!1,u.shift=!1},mouseClick:function(e){if(u.isSelecting=!0,2===e.button)return setTimeout(function(){r.bubble.show()},50),void e.preventDefault();if(r.bubble.isVisible()){var t=r.bubble.element,n=t.offset().left,o=t.offset().top,i=t.width(),a=t.height();if(s>n&&n+i>s&&c>o&&o+a>c)return}},mouseUp:function(e){e.preventDefault(),u.isSelecting=!1,setTimeout(function(){var e=r.utils.selection.save();e.collapsed?r.bubble.clear():r.bubble.show()},50)},mouseMove:function(e){s=e.pageX,c=e.pageY},blur:function(){r.setPlaceholder({focus:!1})}},events:{commands:{bold:function(e){e.preventDefault(),t.execCommand("bold",!1),r.bubble.update()},italic:function(e){e.preventDefault(),t.execCommand("italic",!1),r.bubble.update()},underline:function(e){e.preventDefault(),t.execCommand("underline",!1),r.bubble.update()},anchor:function(e){e.preventDefault();var t=r.utils.selection.save();r.bubble.showLinkInput(t)},createLink:function(e,n){r.utils.selection.restore(n),t.execCommand("createLink",!1,e.url),r.bubble.update()},removeLink:function(t,n){var o=e(r.utils.selection.getContainer(n)).closest("a");o.contents().first().unwrap()},h1:function(n){n.preventDefault(),e(window.getSelection().anchorNode.parentNode).is("h1")?t.execCommand("formatBlock",!1,"<p>"):t.execCommand("formatBlock",!1,"<h1>"),r.bubble.update()},h2:function(n){n.preventDefault(),e(window.getSelection().anchorNode.parentNode).is("h2")?t.execCommand("formatBlock",!1,"<p>"):t.execCommand("formatBlock",!1,"<h2>"),r.bubble.update()},ul:function(e){e.preventDefault(),t.execCommand("insertUnorderedList",!1),r.bubble.update()},ol:function(e){e.preventDefault(),t.execCommand("insertOrderedList",!1),r.bubble.update()},undo:function(e){e.preventDefault(),t.execCommand("undo",!1)}},enterKey:function(e){return"inline"===r.element.attr("editor-mode")?void e.preventDefault():void 0},paste:function(){setTimeout(function(){r.element.find("*").each(function(){var t=e(this);e.each(this.attributes,function(){"class"===this.name&&t.hasClass("placeholder")||t.removeAttr(this.name)})})},100)}}}),r.init()},a=function(){var o,i;i=this,o="MacIntel"==n.navigator.platform,e.extend(this,{keyboard:{isCommand:function(e,t,n){o&&e.metaKey||!o&&e.ctrlKey?t():n()},isShift:function(e,t,n){e.shiftKey?t():n()},isModifier:function(e,t){var n=e.which,o=modifiers[n];o&&t(o)},isEnter:function(e,t){13===e.which&&t()},isArrow:function(e,t){(e.which>=37||e.which<=40)&&t()}},html:{addTag:function(n,o,i,a){var l=e(t.createElement(o));return l.attr("contenteditable",Boolean(a)),l.append(" "),n.append(l),i&&(cache.focusedElement=n.children().last(),this.cursor.set(n,0,cache.focusedElement)),l},decode:function(t){return e("<div/>").html(t).text()}},cursor:{set:function(e,o,i){var a;if(t.createRange){a=t.createRange();var l=n.getSelection(),r=e.children().last(),s=r.html().length-1,c=i?i[0]:r[0],u="undefined"!=typeof o?o:s;a.setStart(c,u),a.collapse(!0),l.removeAllRanges(),l.addRange(a)}else a=t.body.createTextRange(),a.moveToElementText(i),a.collapse(!1),a.select()}},selection:{save:function(){if(n.getSelection){var e=n.getSelection();if(e.rangeCount>0)return e.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restore:function(e){if(e)if(n.getSelection){var o=n.getSelection();o.removeAllRanges(),o.addRange(e)}else t.selection&&e.select&&e.select()},getText:function(){var e="";return n.getSelection?e=n.getSelection().toString():t.getSelection?e=t.getSelection().toString():t.selection&&(e=t.selection.createRange().text),e},clear:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getContainer:function(e){return n.getSelection&&e&&e.commonAncestorContainer?e.commonAncestorContainer:t.selection&&e&&e.parentElement?e.parentElement():null}},validation:{isUrl:function(e){return/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(e)}}})},l=function(t){var i=this;e.extend(i,{isVisible:function(){return i.element.is(":visible")},updatePos:function(){var t=n.getSelection(),a=t.getRangeAt(0),l=a.getBoundingClientRect(),r=i.element.width(),s=i.element.height(),c=(i.notebook.element.offset().left,{x:l.left+l.width/2-r/2,y:l.top-s-8+e(document).scrollTop()});o.translate(i.element,c.x,c.y)},updateState:function(){i.element.find("button").removeClass("active");var e=n.getSelection(),t=[];i.checkForFormatting(e.focusNode,t);for(var o={b:"bold",i:"italic",u:"underline",h1:"h1",h2:"h2",a:"anchor",ul:"ul",ol:"ol"},a=0;a<t.length;a++){var l=t[a];i.element.find("button."+o[l]).addClass("active")}},checkForFormatting:function(e,t){var n=["b","i","u","h1","h2","ol","ul","li","a"];("#text"===e.nodeName||-1!=n.indexOf(e.nodeName.toLowerCase()))&&("#text"!=e.nodeName&&t.push(e.nodeName.toLowerCase()),i.checkForFormatting(e.parentNode,t))},buildMenu:function(){var t=i.notebook.utils.html.addTag(i.element,"ul",!1,!1);for(var n in i.notebook.options.modifiers){var o=i.notebook.utils.html.addTag(t,"li",!1,!1),a=i.notebook.utils.html.addTag(o,"button",!1,!1);a.attr("editor-command",i.notebook.options.modifiers[n]),a.addClass(i.notebook.options.modifiers[n])}i.element.find("button").click(function(t){t.preventDefault();var n=e(this).attr("editor-command");i.notebook.events.commands[n](t)});var l=i.notebook.utils.html.addTag(i.element,"div",!1,!1);l.addClass("link-area");var r=i.notebook.utils.html.addTag(l,"input",!1,!1);r.attr({type:"text"});var s=i.notebook.utils.html.addTag(l,"button",!1,!1);s.click(function(t){t.preventDefault(),e(this).closest(".link-area").hide(),i.element.find("ul").show()})},init:function(e){i.notebook=e,i.element=i.notebook.utils.html.addTag(i.notebook.element.parent(),"div",!1,!1),i.element.addClass("jquery-notebook bubble"),i.buildMenu()},show:function(){i.element.show(),i.updateState(),i.element.toggleClass("jump"),i.updatePos(),i.element.addClass("active")},update:function(){i.updateState()},clear:function(){i.element.hasClass("active")&&(i.element.removeClass("active"),i.hideLinkInput(),i.showButtons(),setTimeout(function(){i.element.hasClass("active")||i.element.hide()},500))},hideButtons:function(){i.element.find("ul").hide()},showButtons:function(){i.element.find("ul").show()},showLinkInput:function(t){i.hideButtons();var n,o;n=i.element.find("input[type=text]"),o=n.closest(".jquery-notebook").find("button.anchor").hasClass("active"),n.unbind("keydown"),n.keydown(function(n){var a=e(this);i.notebook.utils.keyboard.isEnter(n,function(){n.preventDefault();var e=a.val();i.notebook.utils.validation.isUrl(e)?(n.url=e,i.notebook.events.commands.createLink(n,t),i.clear()):""===e&&o&&(i.notebook.events.commands.removeLink(n,t),i.clear())})}),n.bind("paste",function(){var t=e(this);setTimeout(function(){var e=t.val();/http:\/\/https?:\/\//.test(e)&&(e=e.substring(7),t.val(e))},1)});var a="http://";if(o){var l=e(i.notebook.utils.selection.getContainer(t)).closest("a");a=l.prop("href")||a}i.notebook.element.parent().find(".link-area").show(),n.val(a).focus()},hideLinkInput:function(){i.element.find(".link-area").hide()}}),i.init(t)};e.fn.notebook=function(t){return t=e.extend({},e.fn.notebook.defaults,t),this.each(function(){new i(this,t)})},e.fn.notebook.defaults={autoFocus:!1,placeholder:"Your text here...",mode:"multiline",modifiers:["bold","italic","underline","h1","h2","ol","ul","anchor"]}}(jQuery,document,window);