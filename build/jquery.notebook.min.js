!function(e,t,n){var i,o="MacIntel"==n.navigator.platform,a=0,l=0,c={command:!1,shift:!1},s={66:"bold",73:"italic",85:"underline",112:"h1",113:"h2",122:"undo"},r={keyboard:{isCommand:function(e,t,n){o&&e.metaKey||!o&&e.ctrlKey?t():n()},isShift:function(e,t,n){e.shiftKey?t():n()},isModifier:function(e,t){var n=e.which,i=s[n];i&&t.call(this,i)},isEnter:function(e,t){13===e.which&&t()},isArrow:function(e,t){(e.which>=37||e.which<=40)&&t()}},html:{addTag:function(n,i,o,a){var l=e(t.createElement(i));return l.attr("contenteditable",Boolean(a)),l.append(" "),n.append(l),o&&(c.focusedElement=n.children().last(),r.cursor.set(n,0,c.focusedElement)),l}},cursor:{set:function(e,i,o){var a;if(t.createRange){a=t.createRange();var l=n.getSelection(),c=e.children().last(),s=c.html().length-1,r=o?o[0]:c[0],d="undefined"!=typeof i?i:s;a.setStart(r,d),a.collapse(!0),l.removeAllRanges(),l.addRange(a)}else a=t.body.createTextRange(),a.moveToElementText(o),a.collapse(!1),a.select()}},selection:{save:function(){if(n.getSelection){var e=n.getSelection();if(e.rangeCount>0)return e.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restore:function(e){if(e)if(n.getSelection){var i=n.getSelection();i.removeAllRanges(),i.addRange(e)}else t.selection&&e.select&&e.select()},getText:function(){var e="";return n.getSelection?e=n.getSelection().toString():t.getSelection?e=t.getSelection().toString():t.selection&&(e=t.selection.createRange().text),e},clear:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}},validation:{isUrl:function(e){return/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(e)}}},d={updatePos:function(e,t){var i=n.getSelection(),o=i.getRangeAt(0),a=o.getBoundingClientRect(),l=t.width(),c=t.height(),s=(e.offset().left,{top:a.top-c-8,left:a.left+a.width/2-l/2});t.css(s)},buildMenu:function(t,n){var o=r.html.addTag(n,"ul",!1,!1);for(var a in i.modifiers){var l=r.html.addTag(o,"li",!1,!1),c=r.html.addTag(l,"button",!1,!1);c.attr("editor-command",i.modifiers[a]),c.addClass(i.modifiers[a])}n.find("button").click(function(n){n.preventDefault();var i=e(this).attr("editor-command");h.commands[i].call(t,n)});var s=r.html.addTag(n,"div",!1,!1);s.addClass("link-area");var d=r.html.addTag(s,"input",!1,!1);d.attr({type:"text"});var u=r.html.addTag(s,"button",!1,!1);u.click(function(t){t.preventDefault();e(this).closest(".editor");e(this).closest(".link-area").hide(),e(this).closest(".bubble").find("ul").show()})},show:function(){var t=e(this).parent().find(".bubble");t.length||(t=r.html.addTag(e(this).parent(),"div",!1,!1),t.addClass("jquery-notebook bubble"),d.buildMenu(this,t)),t.show(),d.updatePos(e(this),t)},clear:function(){e(this).parent().find(".bubble").hide(),d.hideLinkInput.call(this),d.showButtons.call(this)},hideButtons:function(){e(this).parent().find(".bubble").find("ul").hide()},showButtons:function(){e(this).parent().find(".bubble").find("ul").show()},showLinkInput:function(t){d.hideButtons.call(this);var n=this,i=e(this).parent().find(".bubble").find("input[type=text]");i.unbind("keydown"),i.keydown(function(i){var o=e(this);r.keyboard.isEnter(i,function(){i.preventDefault();var e=o.val();r.validation.isUrl(e)&&(i.url=e,h.commands.createLink(i,t),d.clear.call(n))})}),i.bind("paste",function(){var t=e(this);setTimeout(function(){var e=t.val();/http:\/\/https?:\/\//.test(e)&&(e=e.substring(7),t.val(e))},1)}),e(this).parent().find(".link-area").show(),i.val("http://").focus()},hideLinkInput:function(){e(this).parent().find(".bubble").find(".link-area").hide()}},u={bindEvents:function(t){t.keydown(f.keydown),t.keyup(f.keyup),t.focus(f.focus),t.bind("paste",h.paste),t.mousedown(f.mouseClick),t.mouseup(f.mouseUp),t.mousemove(f.mouseMove),t.blur(f.blur),e(t).on("modify",function(){console.log("modifiquei")})},setPlaceholder:function(t){if(/^\s*$/.test(e(this).text())){e(this).empty();var n=r.html.addTag(e(this),"p").addClass("placeholder");n.append(e(this).attr("editor-placeholder")),r.html.addTag(e(this),"p","undefined"!=typeof t.focus?t.focus:!1,!0)}else e(this).find(".placeholder").remove()},preserveElementFocus:function(){var e=n.getSelection()?n.getSelection().anchorNode:t.activeElement;if(e){var i=e.parentNode,o=i!==c.focusedElement,a=this.children,l=0;i===this&&(i=e);for(var s=0;s<a.length;s++)if(i===a[s]){l=s;break}o&&(c.focusedElement=i,c.focusedElementIndex=l)}},prepare:function(e,t){if(i=t,e.attr("editor-mode",i.mode),e.attr("editor-placeholder",i.placeholder),e.attr("contenteditable",!0),e.css("position","relative"),e.addClass("jquery-notebook editor"),u.setPlaceholder.call(e,{}),u.preserveElementFocus.call(e),i.autoFocus===!0){var n=e.find("p:not(.placeholder)");r.cursor.set(e,0,n)}}},f={keydown:function(e){var t=this;r.keyboard.isCommand(e,function(){c.command=!0},function(){c.command=!1}),r.keyboard.isShift(e,function(){c.shift=!0},function(){c.shift=!1}),r.keyboard.isModifier.call(this,e,function(t){c.command&&h.commands[t].call(this,e)}),c.shift&&r.keyboard.isArrow.call(this,e,function(){setTimeout(function(){var e=r.selection.getText();""!==e?d.show.call(t):d.clear.call(t)},100)}),13===e.which&&h.enterKey.call(this,e),27===e.which&&d.clear.call(this),86===e.which&&h.paste.call(this,e)},keyup:function(t){r.keyboard.isCommand(t,function(){c.command=!1},function(){c.command=!0}),u.preserveElementFocus.call(this),u.setPlaceholder.call(this,{focus:!0}),e(this).trigger("modify")},focus:function(){c.command=!1,c.shift=!1},mouseClick:function(t){var n=this;if(2===t.button)return setTimeout(function(){d.show.call(n)},50),void t.preventDefault();if(e(this).find(".bubble:visible").length){var i=e(this).find(".bubble:visible"),o=i.offset().left,c=i.offset().top,s=i.width(),r=i.height();if(a>o&&o+s>a&&l>c&&c+r>l)return}d.clear.call(n)},mouseUp:function(){var e=this;setTimeout(function(){var t=r.selection.getText();""!==t?d.show.call(e):d.clear.call(e)},50)},mouseMove:function(e){a=e.pageX,l=e.pageY},blur:function(){}},h={commands:{bold:function(e){e.preventDefault(),t.execCommand("bold",!1)},italic:function(e){e.preventDefault(),t.execCommand("italic",!1)},underline:function(e){e.preventDefault(),t.execCommand("underline",!1)},anchor:function(e){e.preventDefault();var t=r.selection.save();d.showLinkInput.call(this,t)},createLink:function(e,n){r.selection.restore(n),t.execCommand("createLink",!1,e.url)},h1:function(e){e.preventDefault(),t.execCommand("formatBlock",!1,"<h1>")},h2:function(e){e.preventDefault(),t.execCommand("formatBlock",!1,"<h2>")},undo:function(e){e.preventDefault(),t.execCommand("undo",!1)}},enterKey:function(t){return"inline"===e(this).attr("editor-mode")?void t.preventDefault():void 0},paste:function(){var t=e(this);setTimeout(function(){t.find("*").each(function(){var t=e(this);e.each(this.attributes,function(){"class"===this.name&&t.hasClass("placeholder")||t.removeAttr(this.name)})}),e(t).trigger("modify")},100)}};e.fn.notebook=function(t){return t=e.extend({},e.fn.notebook.defaults,t),u.prepare(this,t),u.bindEvents(this),this},e.fn.notebook.defaults={autoFocus:!1,placeholder:"Your text here...",mode:"inline",modifiers:["bold","italic","underline","h1","h2","anchor"]}}(jQuery,document,window);